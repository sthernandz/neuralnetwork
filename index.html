<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mapa Conceptual de Procesos Psicol√≥gicos (TCC)</title>
    
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
    }
    </script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000000;
            color: #ffffff;
            font-family: 'Inter', sans-serif;
            touch-action: none;
        }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            font-size: 1.2em;
            text-shadow: 0 0 5px #00ffff, 0 0 10px #00ffff;
        }
        
        /* Controles m√≥viles */
        #mobile-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 200;
            display: none;
        }
        
        .control-pad {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-template-rows: repeat(3, 60px);
            gap: 10px;
        }
        
        .control-btn {
            background: rgba(0, 136, 255, 0.3);
            border: 2px solid rgba(0, 136, 255, 0.8);
            border-radius: 10px;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 0 10px rgba(0, 136, 255, 0.5);
            transition: all 0.1s;
        }
        
        .control-btn:active {
            background: rgba(0, 136, 255, 0.6);
            transform: scale(0.95);
        }
        
        .control-btn.center {
            grid-column: 2;
            grid-row: 2;
            opacity: 0;
            pointer-events: none;
        }
        
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-down { grid-column: 2; grid-row: 3; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }
        
        #gyro-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            padding: 10px 20px;
            background: rgba(170, 0, 255, 0.5);
            border: 2px solid rgba(170, 0, 255, 0.8);
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: none;
            box-shadow: 0 0 10px rgba(170, 0, 255, 0.5);
        }
        
        #gyro-btn:active {
            background: rgba(170, 0, 255, 0.8);
        }

        #debug-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 200;
            background: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 8px;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            line-height: 1.5;
        }

        #debug-info div {
            margin-bottom: 5px;
        }
        #crosshair {
            position: fixed;
            left: 50%;
            top: 50%;
            width: 32px;
            height: 32px;
            z-index: 5000;
            pointer-events: none;
            transform: translate(-50%, -50%);
        }
        #crosshair:before, #crosshair:after {
            content: '';
            position: absolute;
            background: #00ffff;
            border-radius: 2px;
        }
        #crosshair:before {
            left: 50%;
            top: 0;
            width: 4px;
            height: 100%;
            transform: translateX(-50%);
            box-shadow: 0 0 8px 2px #00ffff80;
        }
        #crosshair:after {
            top: 50%;
            left: 0;
            width: 100%;
            height: 4px;
            transform: translateY(-50%);
            box-shadow: 0 0 8px 2px #00ffff80;
        }
    </style>
</head>
<body>
    <div id="info">Mapa Conceptual de Procesos Psicol√≥gicos (TCC)</div>
    
    <button id="gyro-btn">Activar Giroscopio</button>

    <div id="debug-info">
        <div>Alpha: <span id="gyro-alpha">N/A</span></div>
        <div>Beta: <span id="gyro-beta">N/A</span></div>
        <div>Camera X: <span id="cam-x">N/A</span></div>
        <div>Camera Y: <span id="cam-y">N/A</span></div>
    </div>
    
    <div id="mobile-controls">
        <div class="control-pad">
            <div class="control-btn" id="btn-up">‚Üë</div>
            <div class="control-btn center"></div>
            <div class="control-btn" id="btn-left">‚Üê</div>
            <div class="control-btn" id="btn-down">‚Üì</div>
            <div class="control-btn" id="btn-right">‚Üí</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- CONFIGURACI√ìN DEL MAPA CONCEPTUAL ---
        const NETWORK_RADIUS = 800; // Aumentado para dar m√°s espacio al grafo

        const concepts = [
            // Ra√≠z y Modelos
            { id: 'psicologia_cognitiva', name: 'Psicolog√≠a Cognitiva', category: 'root', emoji: 'üß†' },
            { id: 'tcc', name: 'TCC', category: 'therapy_model', emoji: 'üîÑ' },
            { id: 'olas_tcc', name: 'Olas de la TCC', category: 'therapy_model', emoji: 'üåä' },
            { id: 'ola_1', name: '1ra Ola (Investigaci√≥n)', category: 'therapy_model', emoji: 'üî¨' },
            { id: 'ola_2', name: '2da Ola (Cl√≠nica TCC)', category: 'therapy_model', emoji: 'üßë‚Äç‚öïÔ∏è' },
            { id: 'ola_3', name: '3ra Ola (Calidad de Vida)', category: 'therapy_model', emoji: 'üßò' },
            { id: 'terapias_complementarias', name: 'Terapias Complementarias', category: 'therapy_model', emoji: '‚ú®' },
            { id: 'mindfulness', name: 'Mindfulness', category: 'therapeutic_tool', emoji: 'üßò' },

            // Conceptos Centrales
            { id: 'cognicion', name: 'Cognici√≥n', category: 'core_concept', emoji: 'üí°' },
            { id: 'triada_cognitiva', name: 'Tr√≠ada Cognitiva', category: 'core_concept', emoji: 'üîó' },
            { id: 'pensamiento', name: 'Pensamiento', category: 'core_concept', emoji: 'ü§î' },
            { id: 'emocion', name: 'Emoci√≥n', category: 'core_concept', emoji: 'üòä' },
            { id: 'conducta', name: 'Conducta', category: 'core_concept', emoji: 'üèÉ' },
            { id: 'afecto', name: 'Afecto', category: 'core_concept', emoji: '‚ù§Ô∏è' },
            { id: 'estado_animo', name: 'Estado de √Ånimo', category: 'core_concept', emoji: '‚òÅÔ∏è' },
            { id: 'patrones', name: 'Patrones', category: 'core_concept', emoji: 'üîÅ' },
            { id: 'distorsiones_cognitivas', name: 'Distorsiones Cognitivas', category: 'symptom', emoji: 'üå™Ô∏è' },
            { id: 'pensamiento_dicotomico', name: 'Pensamiento Dicot√≥mico', category: 'symptom', emoji: '‚ö´‚ö™' },
            { id: 'sobregeneralizacion', name: 'Sobregeneralizaci√≥n', category: 'symptom', emoji: 'üìà' },
            { id: 'catastrofismo', name: 'Catastrofismo', category: 'symptom', emoji: 'üí•' },

            // Patolog√≠as y S√≠ntomas
            { id: 'trastorno', name: 'Trastorno', category: 'pathology', emoji: 'ü©∫' },
            { id: 'desorden', name: 'Desorden', category: 'pathology', emoji: '‚ö†Ô∏è' },
            { id: 'depresion', name: 'Depresi√≥n', category: 'pathology', emoji: 'üåßÔ∏è' },
            { id: 'depresion_mayor', name: 'Depresi√≥n Mayor', category: 'pathology', emoji: 'üìâ' },
            { id: 'melancolia', name: 'Melancol√≠a', category: 'pathology', emoji: 'ü•Ä' },
            { id: 'triada_depresion', name: 'Tr√≠ada Cognitiva de la Depresi√≥n', category: 'pathology', emoji: '‚õìÔ∏è' },
            { id: 'vision_neg_simismo', name: 'Visi√≥n Negativa (S√≠ Mismo)', category: 'symptom', emoji: 'üôç' },
            { id: 'vision_neg_entorno', name: 'Visi√≥n Negativa (Entorno)', category: 'symptom', emoji: 'üåç' },
            { id: 'vision_neg_futuro', name: 'Visi√≥n Negativa (Futuro)', category: 'symptom', emoji: 'üîÆ' },
            { id: 'tristeza_vital', name: 'Tristeza Vital', category: 'symptom', emoji: 'üíß' },
            { id: 'anhedonia', name: 'Anhedonia', category: 'symptom', emoji: 'üö´üéâ' },
            { id: 'inhibicion_psicomotriz', name: 'Inhibici√≥n Psicomotriz', category: 'symptom', emoji: 'üêå' },
            { id: 'trauma_residual', name: 'Trauma Residual', category: 'pathology', emoji: 'ü©π' },

            // Proceso Terap√©utico
            { id: 'relacion_terapeutica', name: 'Relaci√≥n Terap√©utica', category: 'therapeutic_process', emoji: 'ü§ù' },
            { id: 'alianza_terapeutica', name: 'Alianza Terap√©utica', category: 'therapeutic_process', emoji: 'üßë‚Äç‚öïÔ∏èü§ùüßë' },
            { id: 'admision_tcc', name: 'Proceso de Admisi√≥n (TCC)', category: 'therapeutic_process', emoji: 'üìã' },
            { id: 'empatia', name: 'Empat√≠a', category: 'therapeutic_process', emoji: 'ü§ó' },
            { id: 'empatia_cognitiva', name: 'Empat√≠a Cognitiva', category: 'therapeutic_process', emoji: 'üß†üí°' },
            { id: 'empatia_emocional', name: 'Empat√≠a Emocional', category: 'therapeutic_process', emoji: '‚ù§Ô∏è‚Äçü©π' },
            { id: 'ecpatia', name: 'Ecpat√≠a', category: 'therapeutic_process', emoji: 'üõ°Ô∏è' },
            { id: 'iatrogenia', name: 'Iatrogenia', category: 'therapeutic_process', emoji: 'üíî' },
            { id: 'furor_curandis', name: 'Furor Curandis', category: 'therapeutic_process', emoji: 'üèÉ‚Äç‚ôÇÔ∏èüí®' },
            { id: 'sanar', name: 'Sanar', category: 'therapeutic_process', emoji: 'üå±' },
            { id: 'curar', name: 'Curar', category: 'therapeutic_process', emoji: 'üíä' },

            // Herramientas Terap√©uticas
            { id: 'psicoeducacion', name: 'Psicoeducaci√≥n', category: 'therapeutic_tool', emoji: 'üìö' },
            { id: 'bitacora', name: 'Bit√°cora', category: 'therapeutic_tool', emoji: 'üìì' },
            { id: 'tecnicas_tcc', name: 'T√©cnicas TCC', category: 'therapeutic_tool', emoji: 'üõ†Ô∏è' },
            { id: 'tecnicas_cognitivas', name: 'T√©cnicas Cognitivas', category: 'therapeutic_tool', emoji: 'üß†üîÑ' },
            { id: 'tecnicas_conductuales', name: 'T√©cnicas Conductuales', category: 'therapeutic_tool', emoji: 'üèÉüîÑ' },
            { id: 'reestructuracion_cognitiva', name: 'Reestructuraci√≥n Cognitiva', category: 'therapeutic_tool', emoji: 'üèóÔ∏è' },
            { id: 'activacion_conductual', name: 'Activaci√≥n Conductual', category: 'therapeutic_tool', emoji: 'üöÄ' },
            { id: 'exposicion_gradual', name: 'Exposici√≥n Gradual', category: 'therapeutic_tool', emoji: 'ü™ú' },
            { id: 'recaida_programada', name: 'Reca√≠da Programada', category: 'therapeutic_tool', emoji: '‚òî' },

            // Roles
            { id: 'paciente', name: 'Paciente', category: 'personnel', emoji: 'üßë' },
            { id: 'cliente', name: 'Cliente', category: 'personnel', emoji: 'üíº' },
            { id: 'consultante', name: 'Consultante', category: 'personnel', emoji: 'üó£Ô∏è' },
            { id: 'adalid_estrategico', name: 'Adalid Estrat√©gico', category: 'personnel', emoji: 'üõ°Ô∏èü§ù' }
        ];

        const relationships = [
            // Ra√≠z y Modelos
            { source: 'psicologia_cognitiva', target: 'cognicion', label: 'estudia la' },
            { source: 'psicologia_cognitiva', target: 'olas_tcc', label: 'evoluciona en' },
            { source: 'olas_tcc', target: 'ola_1', label: 'incluye' },
            { source: 'olas_tcc', target: 'ola_2', label: 'incluye' },
            { source: 'olas_tcc', target: 'ola_3', label: 'incluye' },
            { source: 'ola_2', target: 'tcc', label: 'establece la' },
            { source: 'ola_3', target: 'terapias_complementarias', label: 'incorpora' },
            { source: 'terapias_complementarias', target: 'mindfulness', label: 'ejemplo' },
            { source: 'tcc', target: 'triada_cognitiva', label: 'se basa en' },
            { source: 'tcc', target: 'psicoeducacion', label: 'utiliza' },
            { source: 'tcc', target: 'tecnicas_tcc', label: 'utiliza' },
            { source: 'tcc', target: 'relacion_terapeutica', label: 'requiere' },
            { source: 'tcc', target: 'admision_tcc', label: 'inicia con' },

            // Conceptos Centrales
            { source: 'triada_cognitiva', target: 'pensamiento', label: 'compuesta por' },
            { source: 'triada_cognitiva', target: 'emocion', label: 'compuesta por' },
            { source: 'triada_cognitiva', target: 'conducta', label: 'compuesta por' },
            { source: 'cognicion', target: 'distorsiones_cognitivas', label: 'puede tener' },
            { source: 'pensamiento', target: 'distorsiones_cognitivas', label: 'puede ser' },
            { source: 'distorsiones_cognitivas', target: 'pensamiento_dicotomico', label: 'ejemplo' },
            { source: 'distorsiones_cognitivas', target: 'sobregeneralizacion', label: 'ejemplo' },
            { source: 'distorsiones_cognitivas', target: 'catastrofismo', label: 'ejemplo' },
            { source: 'emocion', target: 'estado_animo', label: 'prolongada es' },
            { source: 'emocion', target: 'afecto', label: 'dif. de' },
            { source: 'patrones', target: 'pensamiento', label: 'incluye' },
            { source: 'patrones', target: 'emocion', label: 'incluye' },
            { source: 'patrones', target: 'conducta', label: 'incluye' },

            // Patolog√≠as
            { source: 'trastorno', target: 'desorden', label: 'dif. de' },
            { source: 'trastorno', target: 'paciente', label: 'define al' },
            { source: 'depresion', target: 'trastorno', label: 'es un' },
            { source: 'depresion', target: 'triada_depresion', label: 'explicada por' },
            { source: 'depresion', target: 'tristeza_vital', label: 's√≠ntoma patognom√≥nico' },
            { source: 'depresion', target: 'anhedonia', label: 's√≠ntoma patognom√≥nico' },
            { source: 'depresion', target: 'inhibicion_psicomotriz', label: 's√≠ntoma patognom√≥nico' },
            { source: 'triada_depresion', target: 'vision_neg_simismo', label: 'incluye' },
            { source: 'triada_depresion', target: 'vision_neg_entorno', label: 'incluye' },
            { source: 'triada_depresion', target: 'vision_neg_futuro', label: 'incluye' },
            { source: 'depresion_mayor', target: 'melancolia', label: 'dif. de' },
            { source: 'depresion_mayor', target: 'curar', label: 'se puede' },
            { source: 'melancolia', target: 'sanar', label: 'se puede (tratar)' },
            { source: 'sanar', target: 'curar', label: 'dif. de' },
            { source: 'sanar', target: 'trauma_residual', label: 'implica elaborar' },

            // Proceso Terap√©utico
            { source: 'relacion_terapeutica', target: 'alianza_terapeutica', label: 'construye' },
            { source: 'relacion_terapeutica', target: 'empatia', label: 'requiere' },
            { source: 'relacion_terapeutica', target: 'iatrogenia', label: 'evita la' },
            { source: 'empatia', target: 'ecpatia', label: 'requiere balance con' },
            { source: 'empatia', target: 'empatia_cognitiva', label: 'tipo de' },
            { source: 'empatia', target: 'empatia_emocional', label: 'tipo de' },
            { source: 'iatrogenia', target: 'furor_curandis', label: 'causada por' },

            // Herramientas
            { source: 'bitacora', target: 'triada_cognitiva', label: 'registra la' },
            { source: 'bitacora', target: 'distorsiones_cognitivas', label: 'identifica' },
            { source: 'tecnicas_tcc', target: 'tecnicas_cognitivas', label: 'incluye' },
            { source: 'tecnicas_tcc', target: 'tecnicas_conductuales', label: 'incluye' },
            { source: 'tecnicas_cognitivas', target: 'reestructuracion_cognitiva', label: 'ejemplo' },
            { source: 'reestructuracion_cognitiva', target: 'distorsiones_cognitivas', label: 'modifica' },
            { source: 'tecnicas_conductuales', target: 'activacion_conductual', label: 'ejemplo' },
            { source: 'tecnicas_conductuales', target: 'exposicion_gradual', label: 'ejemplo' },
            { source: 'activacion_conductual', target: 'depresion', label: '√∫til en' },
            { source: 'recaida_programada', target: 'tecnicas_tcc', label: 'es una' },

            // Roles
            { source: 'paciente', target: 'cliente', label: 'dif. de' },
            { source: 'paciente', target: 'consultante', label: 'dif. de' },
            { source: 'adalid_estrategico', target: 'paciente', label: 'acompa√±a al' },
            { source: 'adalid_estrategico', target: 'depresion_mayor', label: 'necesario en' }
        ];


        const categoryColors = {
            root: new THREE.Color(0xff0044), // Rojo
            therapy_model: new THREE.Color(0x0088ff), // Azul
            core_concept: new THREE.Color(0xff8800), // Naranja
            pathology: new THREE.Color(0xaa00ff), // P√∫rpura
            therapeutic_tool: new THREE.Color(0x00ff88), // Verde
            therapeutic_process: new THREE.Color(0x00ffff), // Cian
            personnel: new THREE.Color(0xffff00), // Amarillo
            symptom: new THREE.Color(0xcccccc) // Gris
        };

        // --- INICIALIZACI√ìN DE LA ESCENA 3D ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        camera.position.z = 50;
        camera.rotation.order = 'YXZ';
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        // --- POST-PROCESSING PARA EL EFECTO GLOW (BLOOM) ---
        const composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        composer.addPass(bloomPass);

        const BLOOM_LAYER = 1;

        // --- LUCES ---
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        const pointLight = new THREE.PointLight(0xffffff, 1, 2000);
        scene.add(pointLight);

        // --- FUNCI√ìN PARA CREAR TEXTO (SPRITES) ---
        function makeTextSprite(message, opts) {
            const parameters = opts || {};
            const fontface = parameters.fontface || 'Arial';
            const fontsize = parameters.fontsize || 20;
            const textColor = parameters.textColor || { r: 255, g: 255, b: 255, a: 1.0 };
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            context.font = `Bold ${fontsize}px ${fontface}`;
            const metrics = context.measureText(message);
            const textWidth = metrics.width;
            canvas.width = textWidth + 10;
            canvas.height = fontsize + 10;
            context.font = `Bold ${fontsize}px ${fontface}`;
            context.fillStyle = `rgba(${textColor.r}, ${textColor.g}, ${textColor.b}, ${textColor.a})`;
            context.fillText(message, 5, fontsize - 2);
            const texture = new THREE.Texture(canvas);
            texture.needsUpdate = true;
            const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(canvas.width / 4, canvas.height / 4, 1.0);
            return sprite;
        }

        // --- CREACI√ìN DEL MAPA CONCEPTUAL 3D ---
        const nodeObjects = new Map();
        const nodeGeometry = new THREE.SphereGeometry(3, 24, 24);

        concepts.forEach(concept => {
            const color = categoryColors[concept.category] || new THREE.Color(0xffffff);
            const material = new THREE.MeshBasicMaterial({ color: color });
            const nodeMesh = new THREE.Mesh(nodeGeometry, material);
            
            const nodeGroup = new THREE.Group();
            nodeGroup.position.x = (Math.random() - 0.5) * NETWORK_RADIUS;
            nodeGroup.position.y = (Math.random() - 0.5) * NETWORK_RADIUS;
            nodeGroup.position.z = (Math.random() - 0.5) * NETWORK_RADIUS;
            
            // --- MODIFICACI√ìN AQU√ç ---
            // Se concatena el emoji con el nombre del concepto
            const labelMessage = concept.emoji + " " + concept.name;
            
            const labelSprite = makeTextSprite(labelMessage, {
                fontsize: 24,
                textColor: { r: color.r * 255, g: color.g * 255, b: color.b * 255, a: 1.0 }
            });
            // --- FIN DE LA MODIFICACI√ìN ---
            
            labelSprite.position.set(0, 6, 0);

            nodeGroup.add(nodeMesh);
            nodeGroup.add(labelSprite);
            nodeGroup.layers.enable(BLOOM_LAYER);
            
            scene.add(nodeGroup);
            nodeObjects.set(concept.id, nodeGroup);
        });

        relationships.forEach(rel => {
            const startNode = nodeObjects.get(rel.source);
            const endNode = nodeObjects.get(rel.target);
            if (!startNode || !endNode) return;

            const startColor = startNode.children[0].material.color;
            const points = [startNode.position, endNode.position];
            const linkGeometry = new THREE.BufferGeometry().setFromPoints(points);
            const linkMaterial = new THREE.LineBasicMaterial({ color: startColor, transparent: true, opacity: 0.7 });
            const line = new THREE.Line(linkGeometry, linkMaterial);
            line.layers.enable(BLOOM_LAYER);
            scene.add(line);

            const midpoint = new THREE.Vector3().addVectors(startNode.position, endNode.position).multiplyScalar(0.5);
            const unionSprite = makeTextSprite(rel.label, {
                fontsize: 16,
                textColor: { r: 0, g: 200, b: 200, a: 0.9 }
            });
            unionSprite.position.copy(midpoint);
            unionSprite.layers.enable(BLOOM_LAYER);
            scene.add(unionSprite);
        });

        // --- CONTROLES ---
        const keyboard = {};
        const playerSpeed = 2.0;
        const rotationSpeed = 0.002;

        // Detectar dispositivo m√≥vil
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile) {
            document.getElementById('mobile-controls').style.display = 'block';
            document.getElementById('gyro-btn').style.display = 'block';
        }

        // --- CONTROLES DE TECLADO ---
        document.addEventListener('keydown', (e) => keyboard[e.key.toLowerCase()] = true);
        document.addEventListener('keyup', (e) => keyboard[e.key.toLowerCase()] = false);

        // --- CONTROLES T√ÅCTILES ---
        const touchControls = {
            up: false,
            down: false,
            left: false,
            right: false
        };

        function setupTouchControl(btnId, direction) {
            const btn = document.getElementById(btnId);
            btn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                touchControls[direction] = true;
            });
            btn.addEventListener('touchend', (e) => {
                e.preventDefault();
                touchControls[direction] = false;
            });
        }

        setupTouchControl('btn-up', 'up');
        setupTouchControl('btn-down', 'down');
        setupTouchControl('btn-left', 'left');
        setupTouchControl('btn-right', 'right');

        // --- GIROSCOPIO ---
        let gyroEnabled = false;
        let lastAlpha = null;
        let lastBeta = null;

        async function enableGyro() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requiere permiso
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission === 'granted') {
                        startGyro();
                    }
                } catch (error) {
                    console.error('Error al solicitar permiso:', error);
                    alert('No se pudo activar el giroscopio');
                }
            } else {
                // Android y otros navegadores
                startGyro();
            }
        }

        function startGyro() {
            gyroEnabled = true;
            document.getElementById('gyro-btn').textContent = 'Giroscopio Activo';
            document.getElementById('gyro-btn').style.background = 'rgba(0, 255, 136, 0.5)';
            
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function handleOrientation(event) {
            if (!gyroEnabled) return;

            const alpha = event.alpha; // Rotaci√≥n Z (0-360)
            const beta = event.beta;   // Rotaci√≥n X (-180 a 180)
            
            if (lastAlpha !== null && lastBeta !== null) {
                const deltaAlpha = (alpha - lastAlpha) * Math.PI / 180;
                const deltaBeta = (beta - lastBeta) * Math.PI / 180;
                
                camera.rotation.y += deltaAlpha; //* 0.5;
                camera.rotation.x += deltaBeta; //* 0.5;
            }
            
            lastAlpha = alpha;
            lastBeta = beta;

            // Actualizar display de depuraci√≥n
            document.getElementById('gyro-alpha').textContent = alpha !== null ? alpha.toFixed(2) : 'N/A';
            document.getElementById('gyro-beta').textContent = beta !== null ? beta.toFixed(2) : 'N/A';
        }

        document.getElementById('gyro-btn').addEventListener('click', enableGyro);

        // --- CONTROL DE RAT√ìN (DESKTOP) ---
        document.addEventListener('mousemove', onDocumentMouseMove);

        function onDocumentMouseMove(event) {
            if (document.pointerLockElement === document.body) {
                camera.rotation.y -= event.movementX * rotationSpeed;
                camera.rotation.x -= event.movementY * rotationSpeed;
                camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
            }
        }

        function updatePlayer() {
            // Crear vector de direcci√≥n basado en la rotaci√≥n de la c√°mara
            const direction = new THREE.Vector3(0, 0, -1);
            direction.applyQuaternion(camera.quaternion);
            
            // Controles de teclado - mover en la direcci√≥n de la c√°mara
            if (keyboard['w'] || keyboard['arrowup']) camera.position.addScaledVector(direction, playerSpeed);
            if (keyboard['s'] || keyboard['arrowdown']) camera.position.addScaledVector(direction, -playerSpeed);
            
            // Movimiento lateral (strafe) perpendicular a la direcci√≥n
            const right = new THREE.Vector3(1, 0, 0);
            right.applyQuaternion(camera.quaternion);
            if (keyboard['a'] || keyboard['arrowleft']) camera.position.addScaledVector(right, -playerSpeed);
            if (keyboard['d'] || keyboard['arrowright']) camera.position.addScaledVector(right, playerSpeed);
            
            // Controles t√°ctiles (similar para consistencia)
            if (touchControls.up) camera.position.addScaledVector(direction, playerSpeed);
            if (touchControls.down) camera.position.addScaledVector(direction, -playerSpeed);
            if (touchControls.left) camera.position.addScaledVector(right, -playerSpeed);
            if (touchControls.right) camera.position.addScaledVector(right, playerSpeed);
        }
        
        // --- LOOP DE ANIMACI√ìN ---
        function animate() {
            requestAnimationFrame(animate);
            updatePlayer();
            pointLight.position.copy(camera.position);

            nodeObjects.forEach(node => {
                const label = node.children[1];
                if (label) {
                    label.quaternion.copy(camera.quaternion);
                }
            });

            // Actualizar display de depuraci√≥n para la c√°mara
            document.getElementById('cam-x').textContent = (camera.rotation.x * 180 / Math.PI).toFixed(2);
            document.getElementById('cam-y').textContent = (camera.rotation.y * 180 / Math.PI).toFixed(2);

            composer.render();
        }

        // --- MANEJO DE VENTANA ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
        
        if (!isMobile) {
            document.addEventListener('click', () => {
                document.body.requestPointerLock();
            });
        }

        animate();
    </script>
    <div id="crosshair"></div>
</body>
</html>